<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8" />
    <title>NodeSearch</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="<%= deployPath %>/stylesheets/style.css">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdn.socket.io/socket.io-1.3.5.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script>
    $(function () {

        // Initialize the Socket that we will be talking to the server over.
        // The path of the server is passed in, '/socket.io' is the default
        // If the socket isn't listening at the root of the URL, prepend the
        // path value with the path the socket is listening at
        var socket = io.connect('http://' + window.location.hostname + ':' + window.location.port, { path: '/socket.io' });
        console.log('https://' + window.location.hostname + ':' + window.location.port + '/socket.io');
        var user = '';

        console.log('connection established');

        // Input Text Fields, Find Results With Section
        var $searchText = $('input:text.search-text');
        // If any text field receive input disable it
        $searchText.on('change', function(){
            var changed = $(this);
            $searchText.not(this).each(function(){
                if (changed.val().length > 0){
                    $(this).attr('disabled', 'disabled');
                    $(this).val('');
                } else
                    $(this).removeAttr('disabled');
            });
        });

        $('.md-criteria-value:last').change(function(){
            var $addMdBtn = $('input:button.add-md-btn:last');
            var $rmMdBtn = $('input:button.rm-md-btn:last');

            console.log('last criteria field changed');
            if ($('.md-criteria-value:last').val().length === 0) {
                $addMdBtn.attr('disabled', 'disabled');
                $rmMdBtn.attr('disabled', 'disabled');
            }
            else {
                $addMdBtn.removeAttr('disabled');
                $rmMdBtn.removeAttr('disabled');
            }
        });

        $('input:button.add-md-btn:last').on('click', function(e){
            console.log('add button pressed');
            e.preventDefault();

            var $lastMdCriteria = $('.md-criteria-row:last');
            var $newMdCriteria = $lastMdCriteria.clone();

            // Buttons should only exist on the most recent row
            $(this).addClass('hidden');
            $(this).attr('disabled', 'disabled');

            $newMdCriteria.find('.md-criteria-value').val('');
            $newMdCriteria.insertAfter($lastMdCriteria);

            $('input:button.rm-md-btn:last').removeClass('hidden');
            $('input:button.rm-md-btn:last').removeAttr('disabled');
        });

        $('input:button.rm-md-btn:last').on('click', function(e){
            e.preventDefault();

            // Get the last md-criteria-row and delete it
            $('md-criteria-row:last').remove();
        });


        $('input:button.search-button').on('click', function (e) {
            debugger;
            var requestData = {};
            var metadata = [];

            e.preventDefault();
            console.log('submit pressed');
            user = $('input:text.username').val();

            // Instantiate our requestData object
            // This is where the values for our search will be stored
            // so they may be passed to NodeSearch
            var requestData = {
                Username: user,
                FolderId: 0
            };

            // Checking for Metadata (Very Important!)
            // --------------------------------------------------------------
            // The first thing we want to do is start by determing if we have any
            // fields that add Metadata to the requestData object. If we do
            // then we don't need to worry about search type because the Type
            // must be set to Type = 'v'. This will simplify a lot of the logic
            // later on because we can short circuit most if it by just checking
            // for the existence of the Type property on the requestData

            // Checkbox Fields, Content Types
            var $contentTypes = $('input:checkbox.contentType:checked');
            $contentTypes.each(function(){
                console.log(this.value);
                var mdCriteria = {
                    Id: 16,
                    TextClause: 'contains',
                    Criteria: this.value.toString(),
                    SearchClause: 'or'
                };

                // Add the metadata criteria to the metadata list
                metadata.push(mdCriteria);
            });

            $('.md-criteria-row').each(function(){
                if ($(this).find('.md-criteria-value').val().length > 0){
                    var mdCriteria = {
                        Id: $(this).find('.md-id option:selected').val(),
                        TextClause: $(this).find('.md-text-clause option:selected').val(),
                        Criteria: $(this).find('.md-criteria-value').val(),
                        SearchClause: $(this).find('.md-search-clause option:selected').val()
                    };
                    metadata.push(mdCriteria);
                }
            })

            // If we have metadata, add it to the list
            if (metadata.length > 0){
                requestData.Metadata = metadata;
                requestData.MetaClause = 'and';
                requestData.Type = 'v';
            }

            // If we have Dates at all we need to make sure that the Search Type
            // is an Advanced Search(Type='v') because this is required. If the
            // Type is already set to a Search Type of 'v' then everything is okay
            // and we can proceed. If there is no Type set yet or if the Type !== 'v'
            // then we need to set it to 'v' no matter what.
            $('input[type="date"]').each(function(){
                if ($(this).val().length > 0){
                    if (typeof requestData.Type === 'undefined' || requestData.Type !== 'v')
                        requestData.Type = 'v';

                    if (this.name === 'fromDate')
                        requestData.FromDate = $(this).val();
                    else if (this.name === 'toDate')
                        requestData.ToDate = $(this).val();
                }
            });

//            $searchText.each(function(){
//                if ($(this).val().length > 0){
//                    if (_.has(requestData, 'Type') && requestData.Type != 'v
//                }
//            })

            console.log('requestData ' + JSON.stringify(requestData, null, 2));

            // Emit to the socket that we want our messages for the data specifeid
            socket.emit('search', requestData);

            $('#results').children().remove();
            $('#errors').children().remove();
        });

        socket.on('folder-list', function (data) {
            var $newFolder = $('<div></div>');
            $newFolder.attr('id', 'folder');
        })

        socket.on('search-result', function (data) {

            var $newResultBlock = $('<div></div>');
            $newResultBlock.attr('id', data.id);

            $newResultBlock.append($('<p>').text(JSON.stringify(data)));

            $('#results').append($newResultBlock);


            console.log('search success, see data below');
            console.log(JSON.stringify(data));
        });

        socket.on('search-failure', function (data) {
            console.log(JSON.stringify(data, null, 2));
            var $newErrorBlock = $('<div></div>');
            $newErrorBlock.attr('class', 'alert alert-danger');
            $newErrorBlock.attr('role', 'alert');
            $newErrorBlock.append(document.createTextNode('error | ' + data.error));
            $('#errors').append($newErrorBlock)
        });

        socket.on('folder-list-failure', function (data) {

            var $newErrorBlock = $('<div></div>');
            $newErrorBlock.attr('class', 'error');

            var $errorText = $('<p></p>');
            $errorText.append(document.createTextNode('error | ' + data.error));

            $newErrorBlock.append($errorText);
            $('#errors').append($newErrorBlock);
        });

        socket.on('search-noresult', function (data) {
            console.log('no results returned');
            var $noResultBlock = $('<div></div>');
            $noResultBlock.attr('class', 'alert alert-info');
            $noResultBlock.attr('role', 'alert');
            $noResultBlock.append(document.createTextNode(data.status + ' | ' + data.statusMessage + ' | criteria passed: ' + JSON.stringify(data.criteria)));

            $('#error').append($noResultBlock);
        });
    });
</script>
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <a href="<%= deployPath %>"><span class="navbar-brand">NodeSearch</span></a>
            </div>
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="<%= deployPath %>/docs">Docs</a></li>
                    <li><a href="<%= deployPath %>/docs-analysis">Search Analysis</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container">
        <div class="row">
            <h1>NodeSearch</h1>
        </div>
        <div class="row">
            <h5>A Node.js implementation of CloudService's SME Search</h5>
        </div>
        <div class="row">
            <div class="col-md-12" id="errors"></div>
        </div>
        <form class="form-horizontal">
            <div class="form-group">
                <label class="col-md-1 control-label"  for="username">Username</label>
                <div class="col-md-11">
                    <input type="text" class="form-control username" name="username" placeholder="Username" />
                </div>
            </div>
        </form>
        <div class="panel panel-primary">
            <div class="panel-heading">Find Results With</div>
            <div class="panel-body">
                <form class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="any-words">Any of these Words</label>
                        <div class="col-sm-10">
                            <input class="form-control search-text" type="text" name="any-words" placeholder="Search for any of these words" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="all-words">All of these Words</label>
                        <div class="col-sm-10">
                            <input class="form-control search-text" type="text" name="all-words" placeholder="Search for all of these words" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="exact-phrase">This Exact Phrase</label>
                        <div class="col-sm-10">
                            <input class="form-control search-text" type="text" name="exact-phrase" placeholder="Search for this exact phrase" />
                        </div>
                    </div>
                </form>
                 <form class="form-horizontal">
                    <div class="form-group">
                        <div class="col-md-4 col-md-offset-4 checkbox">
                            <label>
                                <input type="checkbox" class="text-option" value="wx">
                                    Use Wildcard in Text
                            </label>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4">
                <div class="panel panel-primary">
                    <div class="panel-heading">Search Across</div>
                    <div class="panel-body radio">
                        <div class="form-group">
                            <label>
                                <input type="radio" name="searchAcross" class="search-across" value="contentFilename" checked="checked" />
                                Content & Filename
                            </label>
                        </div>
                        <div class="col-md-offset-1 form-group">
                            <label>
                                <input type="radio" name="searchAcross" class="search-across" value="justContent" />
                                Just Content
                            </label>
                        </div>
                        <div class="col-md-offset-1 form-group">
                            <label>
                                <input type="radio" name="searchAcross" class="search-across" value="justFilename" />
                                Just Filename
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="radio" name="searchAcross" class="search-across" value="Notes" />
                                Notes
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="panel panel-primary">
                    <div class="panel-heading">Content Type</div>
                    <div class="panel-body checkbox">
                        <div class="form-group">
                            <label>
                                <input type="checkbox"  class="contentType" value="transcript" />
                                Transcripts
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" class="contentType" value="exhibit" />
                                Exhibits
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" class="contentType" value="video" />
                                Videos
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" class="contentType" value="other">
                                Other
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="panel panel-primary">
                    <div class="panel-heading">Proceeding Date</div>
                    <div class="panel-body date">
                        <div class="form-group">
                            <label>
                                From Date
                                <input class="form-control date-range date" type="date" name="fromDate" placeholder=""/>
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                To Date
                                <input class="form-control date-range" type="date" name="toDate" placeholder=""/>
                            </label>
                        </div>
                        <div class="row"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="panel panel-primary">
            <div class="panel-heading clearfix">Case Information</div>
            <div class="panel-body">
                <form class="form-inline md-criteria-row">
                    <div class="form-group">
                        <select name="md-search-caluse" class="form-control md-search-clause">
                            <option value="and" selected="selected">And</option>
                            <option value="or">Or</option>
                        </select>
                        <select name="metaname" class="form-control md-id">
                            <option value="1" selected="selected">Witness</option>
                            <option value="2">Court</option>
                            <option value="12">Plaintiff</option>
                            <option value="9">Case</option>
                            <option value="13">Defendant</option>
                            <option value="14">Assignment #</option>
                            <option value="15">Exhibit #</option>
                        </select>
                        <select name="md-text-clause" class="form-control md-text-clause">
                            <option value="equals" selected="selected">Equals</option>
                            <option value="contains">Contains</option>
                        </select>
                        <input class="form-control md-criteria-value" type="text" placeholder="Search for this text" />
                        <input type="button" class="add-md-btn btn btn-default" value="Add" disabled="disabled"/>
                        <input type="button" class="rm-md-btn btn btn-default hidden" value="Remove" disabled="disabled"/>
                    </div>
                </form>
            </div>
        </div>
        <div class="form-group">

        </div>

        </br>
        <form class="form-horizontal">
            <div class="col-md-2 form-group">
                <input type="button" class="search-button btn btn-primary" value="Search" />
            </div>
        </form>
        </br>
        <div id="results"></div>
    </div>
</body>



</html>
